<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <!-- default header name is X-CSRF-TOKEN -->
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

  <!-- Bootstrap core CSS -->
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom styles for this template -->
  <link href="css/main.css" rel="stylesheet">
  <link href="css/all.css" rel="stylesheet"> <!--load all styles -->
  <!-- Bootstrap core JavaScript
     ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script src="js/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.bundle.js"></script>
  <script src="js/loadingoverlay.min.js"></script>
  <link href="css/login.css" rel="stylesheet">
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
</head>
<body>

<div>
  <table class="w-100 mt-2">
    <tr>
        <td id="name"></td>
    </tr>
    <tr>
      <td id="postDate"></td>
    </tr>
    <tr>
      <td id="postTitle"></td>
    </tr>
    <tr>
      <td id="postContent"></td>
    </tr>
    <tr>
      <td id="postCategory"></td>
    </tr>

  </table>
  <br>
  <div id="inputComment">
    <div>
      <textarea class="m-1" rows = "5" style="width: 600px;" id="comment" placeholder="Комментарий"></textarea>
    </div>
    <div>
      <button id="addComment">Сохранить</button>
    </div>
  </div>
</div>

<script>
    fetch('/api/current-role')
        .then(response => response.json())
        .then(blogUser => {
            console.log(blogUser);
            showInputComment(blogUser);
            var id = window.location.pathname.split('/').pop();
            fetch('/api/post/'+id)
                .then(response => response.json())
                .then(json => outputPost(blogUser, json));
  })
</script>

<script>
    function showInputComment(blogUser) {
        var inputComment = document.getElementById("inputComment");
        if (blogUser.role == 'ANONYMOUS') {
            inputComment.parentNode.removeChild(inputComment);
        }
    }
</script>

<script>
    function outputPost(blogUser, post) {
        const name = document.getElementById("name");
        const postDate = document.getElementById("postDate");
        const postTitle = document.getElementById("postTitle");
        const postContent = document.getElementById("postContent");
        const postCategory = document.getElementById("postCategory");
        const comment = document.getElementById("comment");
        const addComment = document.getElementById("addComment");

        name.text = post.blogUser.surname + ' '+ post.blogUser.name;
        postDate.innerHTML = post.postDate;
        postTitle.innerHTML = post.title;
        postContent.innerHTML = post.content;
        postCategory.innerHTML = post.postCategory.name;

        addComment.onclick = function() {
<!--            const postComment = {-->
<!--                id: 0,-->
<!--                post: post,-->
<!--                blogUser: blogUser,-->
<!--                content: ''-->
<!--            };-->

            var postComment = new Object();
            postComment.id = 0;
            postComment.post = post;
            postComment.blogUser = blogUser;
            postComment.content = comment.value;


            postComment = JSON.stringify(postComment);

<!--            post.title = document.getElementById("title").value;-->
<!--            post.content = document.getElementById("content").value;-->
<!--            var postCopy = post;-->
<!--            postCopy = JSON.stringify(postCopy);-->

            let token = $("meta[name='_csrf']").attr("content");
            let header = $("meta[name='_csrf_header']").attr("content");

            fetch('/api/post-comment', {
                method: 'POST',
                headers: {
                    [header]: token,
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: postComment
                })
                .then(response => {
                   if (response.status == 200) {
                       window.location.href = '/';
                   }
                })
            }
    }
</script>

</body>
</html>